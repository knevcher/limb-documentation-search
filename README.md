Limb docs searcher
==================

Поисковик документации по репозиторию Limb
-------------------------------------------------

**Реализация**

    * Scala
    * Postgresql

**Функциональность**

    * Интерфейс пользователя
    * Поиск md файлов по ключевым словам
    * Json API

**Рабочее окружение**

Разработка ведется под ОС Ubuntu 12.04, для корректной работы окружения необходимо поднять следующие сервисы:

    * `postgresql 9.1` (рабочая база данных)
    * `sphinxsearch 2.0` (поисковый движок)

**Настройка development окружения**

1. Получаем основной репозиторий проекта

    $ git clone git@gitlab.eastwoodlab.ru:limb-docs-searcher.git
2. Устанавливаем sbt

    $ wget http://repo.scala-sbt.org/scalasbt/sbt-native-packages/org/scala-sbt/sbt/0.13.0/sbt.deb
    $ dpkg -i sbt.deb
3. Накатываем на базу иницилазационный скрипт из папки `init` `bootstrap.sql`
4. Запускаем searchd c конфигом (не забываем отредактировать его, параметры БД поменять например), который в conf/sphinx.conf. Если хотите сразу же заполнить базу и сфинкс данными - посмотрите на пункт "Индексация ручками" в "Дополнительно".

    $ searchd -c conf/sphinx.conf
5. Копируем conf/application.dev.conf.ex в conf/application.dev.conf и настраиваем в нём всё что нужно (параметры подключения к БД, параметры подключения к Sphinx)
6. Запускем development-сервер
   $ sbt run

**Настройка production окружения**

1. В репозитории текущий работающий релиз лежит в ветке `master`
2. Перед сборкой пакета нужно установить все сборочные зависимости приложения:
   * sbt
   * default-jdk
3. Подготовить базу данных, применить инициализационный скрипт
   * `init/bootstrap.sql`
4. Собрать deb-пакет

   $ debuild -us -uc
 В результате получим пакет limb-docs-searcher
5. Установить deb пакет в систему

   $ gdebi ../limb-docs-searcher_<версия>_all.deb
6. Установить deb пакет со статикой

   $ gdebi ../limb-docs-searcher-static_<версия>_all.deb
7. Настройки приложения находятся в файле `/etc/limb-docs-searcher/application.conf`
8. Настроить подключение к базе данных (параметры db.default.*)
9. Запустить searchd (демон сфинкса) (не забываем отредактировать его, параметры БД поменять например)

   $ searchd -c /etc/limb-docs-searcher/sphinx.conf

    Если хотите сразу же заполнить базу и сфинкс данными - посмотрите на пункт "Индексация ручками" в "Дополнительно".
10. Настроить nginx для раздачи статики (конфиг nginx-static.conf.ex прилагается)

**Управление сервером**

* Запуск
  $ start limb-docs-searcher

* Остановка

  $ stop limb-docs-searcher
* Перезапуск

  $ restart limb-docs-searcher

**Настройка nginx**

1. Для сервера с приложением берём конфиг nginx.conf.ex
2. Для сервера со статикой nginx-static.conf.ex
3. При необходимости редактируем

**Использование**

1. Для поиска надо ввести ключевые слова в единственное поле на главной странице или на странице /search.
2. /search.json так-же, как и /search имеет параметр page.

**Страница /status**
Статусная страница отображает состояние используемый сервисов (Postgres, Sphinx), версию deb-пакета, дату сборки и название.

**Дополнительно**

* Индесация ручками

$ curl -X POST http://0.0.0.0:9000/update?token=<токен>
После заполнения базы необходимо сделать (факт заполнения базы можно узнать по логам)
$ indexer --all --rotate --config <путь к конфигу>/sphinx.conf

**Параметры конфигурации**
secret_token_for_indexing - токен авторизации
sphinx_server - адрес сервера на котором крутится Sphinx
sphinx_port - порт, на котором Sphinx висит
download_limb_if_not_exists - клонировать ли limb, если его нет
limb_git_path - адрес удалённого git репозитория
limb_local_path - куда класть репозиторий на локальной машине
update_limb_local_repo - обновлять ли локальный репозиторий если есть такая возможность
last_modified_file - путь к файлу, в котором хранится дата последней индексации
page_results - количество результатов на страницу
index_name - название индекса Sphinx
count_snippets - количество слов кокруг ключевого в описании
static_url - адрес для статики
